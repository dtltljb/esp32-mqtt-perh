[[EN]](./readme_en.md)

(0) . SPI 接口
		 ____________________________
		|NUM|GPIO | SPI   |TM7705		|
		------------------------------
		|1|GPIO_22|SPI_CS  |CS  	P4 |
		|2|GPIO_25|SPI_MOSI|DI    P14|
		|3|GPIO_19|SPI_SCLK|SCLK  P1 |
		|4|GPIO_23|SPI_MISO|DOUT  P13|
		------------------------------
		|5|GPIO_17|        |RESET P5 |
		|6|GPIO_15|        |DRDY  P12|
		------------------------------

## 1 TM7705 内部寄存器说明

(1). 寄存器概述
			TM7705 片内包括 8 个寄存器,这些寄存器通过器件的串行口访问。
			第一个是通信寄存器,它管理通道选择,决定下一个操作是读操作还是写操作,以及下
			一次读或写哪一个寄存器。所有与器件的通信必须从写入通信寄存器开始。上电或复位后,
			器件等待在通信寄存器上进行一次写操作。 这一写到通信寄存器的数据决定下一次操作是读
			还是写,同时决定这次读操作或写操作在哪个寄存器上发生。所以,写任何其它寄存器首先
			要写通信寄存器,然后才能写选定的寄存器。所有的寄存器 (包括通信寄存器本身和输出
			数据寄存器)进行读操作之前,必须先写通信寄存器,然后才能读选定的寄存器。此外,通
			信寄存器还控制等待模式和通道选择,此外 DRDY 状态也可以从通信寄存器上读出。
			第 2 个寄存器是设置寄存器,决定校准模式、增益设置、单/双极性输入以及缓冲模式。
			第 3 个寄存器是时钟寄存器,包括滤波器选择位和时钟控制位。
			第 4 个寄存器是数据寄存器,器件输出的数据从这个寄存器读出。
			
			最后一个寄存器是校准寄存器,它存储通道校准数据。


(2).  通信寄存器 comunication_reg = 0 000 0 1 0 0
 
			通信寄存器是一个 8 位寄存器, 既可以读出数据也可以把数据写进去。 所有与器件的通
			信必须从写该寄存器开始。写上去的数据决定下一次读操作或写操作在哪个寄存器上发生。
			一旦在选定的寄存器上完成了下一次读操作或写操作,接口返回到通信寄存器接收一次写操
			作的状态。这是接口的默认状态,在上电或复位后,TM7705 就处于这种默认状态等待对通
			信寄存器一次写操作。在接口序列丢失的情况下,如果在 DIN 高电平的写操作持续了足够
			长的时间 (至少 32 个串行时钟周期),TM7705 将会回到默认状态。

BIT7：
			  0/ DRDY 对于写操作,必须有一个 “0”被写到这位,以便通信寄存器上的写操作能够
			准确完成。如果 “1”被写到这位,后续各位将不能写入该寄存器。它会停留在
			该位直到有一个 “0”被写入该位。一旦有 “0”写到 0/ DRDY 位,以下的 7
			位将被装载到通信寄存器。对于读操作,该位提供器件的 DRDY 标志。该位的
			状态与 DRDY 输出引脚的状态相同。

BIT6～4：RS2-RS0 寄存器选择位。
			这 3 个位选择下次读/写操作在 8 个片内寄存器中的哪一个上发生,见表 6(附寄存器大小)。
			当选定的寄存器完成了读/写操作后,器件返回到等待通信寄存器下一次写操作的状态。
			它不会保持在继续访问原寄存器的状态。
			
			 —————————————————————————————————————————————————————————
			| RS2 | RS1 | RS0 |    寄存器             |  寄存器位数      |
			-----------------------------------------------------------
			| 0   |  0  |  0  |   通信寄存器           |       8        |
			| 0   |  0  |  1  |   设置寄存器           |       8        |
			| 0   |  1  |  0  |   时钟寄存器           |       8        |
			| 0   |  1  |  1  |   数据寄存器           |       16       |
			| 1   |  0  |  0  |   测试寄存器           |       8        |
			| 1   |  0  |  1  |   无操作              |                |
			| 1   |  1  |  0  |   偏移寄存器 零标度     |       24       |
			| 1   |  1  |  1  |   增益寄存器 满标度     |       24       |
			-----------------------------------------------------------

BIT3： R/W
			读/ 写选择。这个位选择下次操作是对选定的寄存器读还是写。
			“0”表示下次操作是写,“1 “表示下次操作是读。

BIT2：STBY 等待模式

			此位上写 “1”,则处于等待或掉电模式。在这种模式下,器件消耗的电源电流仅为 10 μ A。 
			在等待模式时,器件将保持它的校准系数和控制字信息。写 “0”,器件处于正常工作模式。

BIT1、BIT0 = CH1、CH0  通道选择

			这 2 个位选择一个通道以供数据转换或访问校准系数。器件内的 3 对校准寄存器用来存储校准系数。 
			如表 7 和 8 所示指出了哪些通道组合是具有独立的校准系数的。
			当 CH1 为逻辑 1 而 CH0 为逻辑 0 时,由表可见对TM7705 是 AIN 1(- )输入脚在内部 自己短路。
			这可以作为评估噪声性能的一种测试方法 (无外部噪声源)。在这种模式下,AIN 1(- )/COMMON 输入端
			必须与一个器件允许的共模电压范围内的外部电压相连接.

		_______________________________________________________
	 | ch1 | ch0 | AIN ( + ) |  AIN ( - ) |   校准寄存器对      |
	 |  0  |  0  | AIN1 +    |  AIN1 -    |   寄存器对 0       |
	 |  0  |  1  | AIN2 +    |  AIN2 -    |   寄存器对 1       |
	 |  1  |  0  | AIN1 -    |  AIN1 -    |   寄存器对 0       |
	 |  1  |  1  | AIN1 -    |  AIN2 -    |   寄存器对 2       |
	 ---------------------------------------------------------

(2) . 设置寄存器 control_reg = b 00 001 1 1 0

			设置寄存器是一个 8 位寄存器,它既可以读数据又可将数据写入。上电/复位状态:01Hex

BIT7\BIT6： = MD1\MD0   工作模式选择

			——————————————————————————————————————————————————————————————————
		 | MD1	| MD0	|                       模式                           |
		 | 0    |  0  |正常模式,在这种模式下,转换器进行正常的模数转换                |
		 | 0    |  1  |自校准。 在通信寄存器的 CH1 和 CH2 选中的通道上激活自校准。    |
		 |      |     |是一步校准,完成此任务后,返回正常模式,                       |
		 | 1    |  0  |零标度系统校准,在通信寄存器的 CH1 和 CH2 选中的通道上激活零标度 |
		 |      |     |系统校准,开始校准时 DRDY 输出或 DRDY位为高电平,零标度系统校准完 |
		 |      |     |成后又回到低电平,这时,在数据寄存器上产生一个新的有效字。         |
		 | 1    |  1  |满标度系统校准,在通信寄存器的 CH1 和 CH2 选中的通道上激活满标度 |
		 |      |     |系统校准,开始校准时 DRDY 输出或 DRDY位为高电平,零标度系统校准完 |
		 |      |     |成后又回到低电平,这时,在数据寄存器上产生一个新的有效字。         |
		 ---------------------------------------------------------------------
 
BIT5～3 ： G2 ～ G0 增益选择位
 
		 —————————————————————————————————
		| G 2 | G1  | G0  |     增益       |
		-----------------------------------
		| 0   |  0  |  0  |      1        |
		| 0   |  0  |  1  |      2        |
		| 0   |  1  |  0  |      4        |
		| 0   |  1  |  1  |      8        |
		| 1   |  0  |  0  |      16       |
		| 1   |  0  |  1  |      32       |
		| 1   |  1  |  0  |      64       |
		| 1   |  1  |  1  |      128      |
		-----------------------------------
 
 BIT2： B / U 
 			单极性/双极性工作，	“0”表示选择双极性操作,“1”表示选择单极性工作。
 
 BIT1： BUF
		 缓冲器控制。 “0”表示片内缓冲器短路,缓冲器短路后,电源电流降低。此位处
		于高电平时,缓冲器与模拟输入串联,输入端允许处理高阻抗源。

 BIT0： FSYNC
		 滤波器同步。该位处于高电平时,数字滤波器的节点、滤波器控制逻辑和校准控
		制逻辑处于复位状态下,同时,模拟调制器也被控制在复位状态下。当处于低电
		平时,调制器和滤波器开始处理数据,并在 3 ×(1/输出更新速率)时间内(也
		就是滤器的稳定时间)产生一个有效字。FSYNC 不影响数字接口,也不使 DRDY
		输出复位 (如果它是低电平)。

(3) . 时钟选择
		上电/复位状态:05Hex 。   select_clock = b 00010001

BIT7～5： ZERO 必须在这些位上写零,
         以确保 TM7705 正确操作。否则,会导致器件的非指定操作。
BIT4：   CLKDIS 主时钟禁止位
         	逻辑 “1”表示阻止主时钟在 MCLK OUT 引脚上输出。禁止时,
					MCLK OUT 输出引脚处于低电平。这种特性使用户可以灵活地使用 MCLK OUT
					引脚,例如可将 MCLK OUT 做为系统内其它器件的时钟源,也可关掉 MCLK
					OUT,使器件具有省电性能。当在 MCLK IN 上连一个外部主时钟,TM7705 继
					续保持内部时钟,并在 CLKDIS 位有效时仍能进行正常转换。当在 MCLK IN 和
					MCLK OUT 之间接一个晶体振荡器或一个陶瓷谐振器, 则当 CLKDIS 位有效时,
					TM7705 时钟将会停止,也不进行模数转换。  
BIT3：		CLKDIV 时钟分频器位。
	 			CLKDIV 置为逻辑 1 时,MCLK IN 引脚处的时钟频率在被
				TM7705 使用前进行 2 分频。例如,将 CLKDIV 置为逻辑 1,用户可以在 MCLK
				IN 和 MCLK OUT 之间用一个 4.9152MHz 的晶体,而在器件内部用规定的
				2.4576MHz 进行操作。CLKDIV 置为逻辑 0,则 MCLK IN 引脚处的频率实际上
				就是器件内部的频率。
BIT2：		CLK时钟位。				
				CLK 位应根据 TM7705 的工作频率而设置。 如果转换器的主时钟频率为
				2.4576MHz (CLKDIV=0 )或为 4.9152MHz (CLKDIV=1 ), CLK 应置 “0”
				如果器件的主时钟频率为 1MHz(CLKDIV=0 )或 2MHz (CLKDIV=1 ),则该位应置
				“1”该位为给定的工作频率设置适当的标度电流,并且也 (与 FS1	和 FS0 一起 )选择
				器件的输出更新率。如果 CLK 没有按照主时钟频率进行正确的设置,则 TM7705 的工作
				将不能达到指标。
BIT1～0：FS1 FS0 滤波器选择位
        它与 CLK 一起决定器件的输出更新率。表 12 显示了滤波器的
				第一陷波和-3dB 频率。片内数字滤波器产生 sinc 3 (或 sinx/x 3 )滤波器响应。
				与增益选择一起, 它也决定了器件的输出噪声。 改变了滤波器的陷波以及选定的
				增益将影响分辨率。表 1 至表 4 示出了滤波器的陷波频率和增益对输出噪声和
				器件分辨率的影响。器件的输出数据率 (或有效转换时间)等于由滤波器的第
				一个陷波选定的频率。例如,如果滤波器的第一个陷波选在 50Hz ,则每个字
				的输出率为 50Hz ,即每 2ms 输出一个新字。当这些位改变后,必须进行一次
				校准。
				
								
					输出更新速率
				 ---------------------------------------------------------
				| CLK | FS1 | FS0 |    输出更新率 (hz)     |滤波器-3dB 截止频率|
				-----------------------------------------------------------
				| 0   |  0  |  0  |   20			           |       5.24     |
				| 0   |  0  |  1  |   25			           |       6.55     |
				| 0   |  1  |  0  |   100			           |       26.2     |
				| 0   |  1  |  1  |   200			           |       52.4     |
				| 1   |  0  |  0  |   50			           |       13.1     |
				| 1   |  0  |  1  |   60			           |       15.7     |
				| 1   |  1  |  0  |   250			           |       65.5     |
				| 1   |  1  |  1  |   500			           |       131      |
				-----------------------------------------------------------


(4) . 零标度校准寄存器	  上电/复位状态:1F4000 Hex ,
		TM7705 包含几组独立的零标度寄存器,每个零标度寄存器负责一个输入通道。它们
		皆为 24 位读/写寄存器,24 位数据必须被写之后才能传送到零标度校准寄存器。零标度寄
		存器和满标度寄存器连在一起使用,组成一个寄存器对。
		当器件被设置成允许通过数字接口访问这些寄存器时,器件本身不再访问寄存器系数以
		使输出数据具有正确的尺度。结果,在访问校准寄存器 (无论是读/写操作 )后,从器件
		读得的第一个输出数据可能包含不正确的数据。
		此外,数据校准期间,校准寄存器不能进行写操作。这类事件可以通过以下方法避免:
		在校准寄存器开始工作前,将模式寄存器的FSYNC 位置为高电平,任务结束后,又将其置为低电平。

(5) . 满标度校准寄存器  上电/复位状态:5761AB Hex ,

		TM7705 包含几个独立的满标度寄存器,每个满标度寄存器负责一个输入通道。它们
		皆为 24 位读/写寄存器,24 位数据必须被写之后才能传送到满标度校准寄存器。满标度寄
		存器和零标度寄存器连在一起使用,组成一个寄存器对。每个寄存器对对应一对通道,见表
		7。当器件被设置成允许通过数字接口访问这些寄存器时,器件本身不再访问寄存器系数以
		使输出数据具有正确的尺度。结果,在访问校准寄存器 (无论是读/写操作 )后,从器件
		读得的第一个输出数据可能包含不正确的数据。此外,数据校准期间,校准寄存器不能进行
		写操作。这类事件可以通过以下方法避免:在校准寄存器开始工作前,将模式寄存器的
		FSYNC 位置为高电平,任务结束后,又将其置为低电平。


## 2  校准过程

			TM7705 包括很多种校准类型,表 13 总结了这些校准类型、操作内容及操作时间。
			有两种方法判断校准是否结束。
			第一种方法是:监视 DRDY ,若 DRDY 返回低电平,则说明校准过程已经结束,
			同时也表明数据寄存器中有一个新的有效数据,这一新的数据就是校准结束后的一次正常的转换结果。
			第二种方法就是:监视设置寄存器的 MD1、MD0 位,若 MD1、MD0 回到 “0”(校准后,MD1、MD0 返 “0”),
			则表明校准过程已经结束, 这种方法不能提示数据寄存器中有无新的转换结果.
			但它比第一种判断方法在时间上要早,也就是能更快地知道校准是否结束。
			Mode 位 (即 MD1、MD0 )返 “0”前的持续时间, DRDY 回到低电平的过程则包括一次正常的转换时间和使第一次转
			换结果具有正确刻度的延迟时间 t p , t p 不超过 2000 ×t CLKIN 。 

(1) . 零标度系统校准
			MD1 = 1, MD0 = 0 ; 选定增益 ==>> 使用 AIN 进行零标度校准 ==> wait for DRDY fall ==> ok
			
(2) . 满标度系统校准
			MD1 = 1, MD0 = 1 ; 选定增益 ==>> 使用 AIN 进行零标度校准 ==> wait for DRDY fall ==> ok
                                          	
## 3 总结
	
	a> .
	TM7705 直接配置通道不进行自校正,测量值偏差较大;上电复位=>自校正=>配置通道参数=>采集参数,精度能够达到千分之七.
测试通道2:跟随器输入988.4mv(安杰伦万用表测试值),tm7705测量值 981.6mv,(988.4 - 981.6)/988.4 = 0.0067

	b> .
	连续两次读取通道值，结果只能读取到1个通道值，此问题暂时存疑。
	

